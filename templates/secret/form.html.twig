<div x-data="secretForm()" class="flex flex-row-reverse gap-4 items-center">
    <button @click="open = !open" class="btn">Activer le code</button>

    <div class="relative flex flex-col gap-4 p-8 rounded-3xl bg-white transition-all secret-form" 
        x-show="open" 
        x-transition>
        <p class="text-sm mx-auto text-black bg-black px-2 py-1">
            Il faut compter les secondes
        </p>
        <input x-model="code" type="password" placeholder="******" class="p-2" />
        <button type="button" @click="verify" class="btn">Envoyer</button>
        <p x-text="error" class="text-red-500"></p>
        <p x-text="secret" class="text-green-500"></p>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('secretForm', () => ({
        open: false,
        code: '',
        error: '',
        secret: '',

        async verify() {
            this.error = '';
            this.secret = '';

            try {
                const formData = new FormData();
                formData.append('code', this.code);

                const res = await fetch('{{ path("app_verify_secret") }}', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    credentials: 'same-origin'
                });

                const data = await res.json();

                if (!res.ok || !data.success) {
                    this.error = 'Code incorrect';
                    return;
                }

                // succès → on affiche le secret reçu
                this.secret = data.secret;
            } catch (e) {
                this.error = 'Erreur réseau';
            }
        }
    }))
})
</script>


